# 웹 로봇

웹 로봇은 사람과의 상호작용 없이 연속된 웹 트랜잭션들을 자동으로 수행하는 소프트웨어 프로그램이다. 많은 로봇들이 웹사이트를 돌아다니면서 콘텐츠를 수집하고, 하이퍼링크를 따라 이동하며 발견한 데이터를 처리한다.

> 예시
>
> - 주식 시장 서버에 매 분마다 데이터 조회 요청을 보내고, 받은 데이터로 주식 추이 그래프를 그리는 주식 그래프 로봇
> - 검색 데이터베이스를 만들기 위해 발견한 모든 문서를 수집하는 검색 엔진 로봇
> - 상품에 대한 가격 데이터베이스를 만들기 위해 온라인 쇼핑몰에서 웹페이지를 수집하는 가격 비교 로봇

<br />

## 크롤러와 크롤링

웹 크롤러는 가져온 웹페이지가 가리키는 모든 웹페이지를 가져오고, 다시 가져온 웹페이지가 가리키는 모든 웹페이지를 가져오는, 재귀적으로 반복해서 웹을 순회하는 로봇이다.  
크롤러가 가져온 문서들은 검색할 수 있는 데이터베이스로 만들어진다.

### 어디에서 시작하는가: ‘루트 집합’

크롤러가 초기에 접속하는 URL을 `루트 집합(root set)`이라고 한다. 웹에서는 모든 문서로 이어지는 하나의 문서란 없다. 다른 웹페이지와 어떤 연결고리도 없는 웹페이지가 있을 수 있기 때문이다. 따라서 좋은 루트 집합이란 아래와 같다.

- 크고 인기 있는 웹사이트
- 새로 생성된 페이지
- 잘 알려져 있지 않은 페이지

### 링크 추출과 상대 링크 정상화

크롤러는 검색한 페이지에 있는 URL 링크들을 파싱해 크롤링할 페이지 목록에 추가한다. 크롤링을 함에 따라 이 목록은 급격히 증가한다.

### 순환 피하기

`A -> B -> C -> A`와 같이 크롤링 하면서 얻은 페이지를 방문하다가 순환에 빠지지 않도록 그들이 어디를 방문했는지 알아야 한다. 순환은 다음의 이유로 크롤러에 해롭다.

- 크롤러를 루프에 빠뜨려서 꼼짝 못하게 만들 수 있다. 같은 페이지들을 반복해서 가져오는데 시간이 낭비되고, 네트워크 대역폭을 차지해 다른 페이지를 가져오는 것 조차 막을 수 있다.
- 웹 서버에 부하를 가져와 실제 사용자가 웹 페이지에 접근하는 것을 막을 수 있다.
- 중복된 콘텐츠만 제공하는 쓸데없는 애플리케이션으로 전락할 수 있다.

### 빵 부스러기의 흔적

어떤 URL을 방문하였는지 지속적으로 추적하는 일은 쉽지 않다.
URL이 굉장히 많기 때문에 어떤 URL에 접속했는지 판단하기 위해 속도와 메모리 사용 면에서 효율적인 자료구조가 사용되어야한다.

- 검색 트리와 해시 테이블  
   방문한 URL을 빠르게 찾을 수 있는 자료구조이다.
- 느슨한 존재 비트맵  
   공간 사용을 최소화하기 위해 `존재 비트 배열`과 같은 느슨한 자료 구조를 이용한다. 각 URL은 해시함수에 의해 고정된 크기의 숫자로 변환되고 배열안에 대응하는 **존재 비트**를 갖는다. 이후 어떤 URL이 크롤링이 되었을 때, 존재 비트가 이미 있다면 크롤링한 적이 있는 URL로 간주한다.
- 체크포인트  
   크롤러가 갑작스럽게 중단될 경우에 대비해 방문한 URL 목록이 디스크에 저장되었는지 확인한다.
- 파티셔닝  
   웹이 성장하면서 한 대의 컴퓨터에서 하나의 로봇만을 이용해 크롤링하기에는 메모리, 연산 능력 등이 충분하지 못해 여러 대의 컴퓨터에서 여러 로봇이 URL을 분담해 크롤링하기 시작했다.

### 별칭과 로봇 순환

올바른 자료 구조를 사용하더라도 URL이 별칭을 갖는 경우 해당 URL이 크롤링된 적 있는 URL인지 파악하기 쉽지 않다.

> 예시  
> http://www.foo.com/ || http://www.foo.com/index.html  
> http://www.foo.eom/x.html#early || http://www.foo.eom/x.html#middle

### URL 정규화하기

웹 로봇은 URL을 표준 형식으로 정규화하여 다른 URL과 같은 리소스를 판단하고 있는지 판단한다.

- 포트번호가 없다면 80으로 간주한다.
- 이스케이핑된 문자들은 대응되는 문자로 변환한다.
- `#` 태그들을 제거한다.

그러나 이외에 웹 로봇이 웹서버에 대한 지식없이는 중복을 피할 수 없는 경우도 있다.

- url에 대소문자 차이가 있는 경우 웹서버의 구분 여부
- 웹 서버의 색인 페이지 설정에 대한 정보
- url에 호스트명이 있는 경우와 IP 주소가 있는 경우에 두 주소의 동일 여부

### 파일 시스템 링크 순환

> 심볼링 링크 ≒ 바로가기 링크
> <img width="634" alt="image" src="https://github.com/flataex/http-the-definitive-guide-study/assets/67260437/0caf45ab-02d7-41c8-bc8a-be99b6ab3e69">

- a의 파일시스템에서 크롤러의 수행동작은 다음과 같다.
  1. www.foo.com/index.html에서 subdir/index.html로 이어지는 링크를 발견한다.
  2. www.foo.com/subdir/index.html에서 subdir/1ogo.gif로 이어지는 링크를 발견한다.
  3. www.foo.com/subdir/logo.gif를 가져오고 더이상 링크가 없어 끝이 난다.
- b의 파일시스템에서 크롤러의 수행동작은 다음과 같다.

  1. www.foo.com/index.html에서 subdir/index.html로 이어지는 링크를 발견한다.
  2. www.foo.com/subdir/index.html을 가져왔지만 같은 index.html로 돌아간다.
  3. www.foo.com/subdir/subdir/index.html을 가져온다.
  4. 다시 되돌아가 www.foo.com/subdir/subdir/subdir/index.html을 가져온다.

  `subdir/` 이 `/`를 가리키는 심볼릭 링크로, 크롤러는 이를 다른 url로 인식해 순환에 빠지게 된다.

### 동적 가상 웹 공간

악의적인 웹서버가 동적으로 가상 URL을 가진 HTML을 무한히 생성해 크롤러가 정에 빠지는 경우가 있다. 동적 콘텐츠로 인해 발생할 수 있는 이러한 결과 때문에, 많은 로봇이 URL의 어딘가에 ‘cgi’라는 문자열을 포함한 사이트 크롤링을 거부한다.

### 루프와 중복 피하기

모든 순환을 피하는 완벽한 방법은 없다. 실제로 잘 설계된 로봇은 순환을 피하기 위해 휴리스틱 집합을 필요로 한다. 휴리스틱은 문제를 피하는데 도움을 주지만 동시에 약간 손실을 유발할 수도 있다. 왜냐하면 의심스러워 보이지만 실은 유효한 콘텐츠를 걸러버리게 되는 일도 일어날 수 있기 때문이다.

이러한 웹에서 로봇이 더 올바르게 동작하기 위해 사용하는 기법들은 다음과 같다.

- URL 정규화
- 너비 우선 크롤링  
   깊이 우선 크롤링 방식을 운용하다 함정에 빠지면 다른 사이트로 빠져나가기 어렵기 때문에 너비 우선 크롤링 방식으로 운용한다.
- 스로틀링  
   일정 시간동안 가져올 수 있는 웹 사이트 개수를 제한한다.  
   만약 로봇이 순환에 빠져 해당 사이트에 지속적으로 접근한다면 스로틀링을 통해 해당 서버에 대한 접근 횟수와 중복 횟수를 제한할 수 있다.
- URL 크기 제한  
   로봇은 일정 크기를 넘어가는 URL에 대한 크롤링을 거부할 수 있다. 순환으로 인해 URL의 크기가 계속 커지다보면 크롤러에 의해 거부될 수 있을 것이다. 이 기법을 적용하면 가져오지 못하는 콘텐츠들도 틀림없이 있을 것이라는 단점이 있다.
- URL/사이트 블랙리스트  
   순환에 빠지거나 함정인 것으로 알려진 URL을 블랙리스트에 추가한다. 블랙리스트는 크롤링 되는 것을 싫어하는 특정 사이트를 피하기 위해 사용될 수 있다.
- 패턴 발견  
   로봇은 심볼링 링크로 인한 순환과 같이, 반복되는 구성요소를 가진 URL을 잠재적인 순환으로 보고, 크롤링하는 것을 거절한다.
- 콘텐츠 지문  
   지문은 중복을 감지하는 직접적인 방법이다. 로봇들은 페이지의 콘텐츠에서 몇 바이트를 얻어내어 `체크섬(checksum)`을 계산한다. 전에 보았던 체크섬을 가진 페이지를 가져온다면, 그 페이지의 링크는 크롤링하지 않는다. 지문 생성용으로는 MD5와 같은 메시지 요약 함수가 인기 있다.
- 사람의 모니터링  
   로봇의 진행 상황을 모니터링해서 뭔가 특이한 일이 일어나면 즉각 인지할 수 있게끔 반드시 진단과 로깅을 포함하도록 설계되어야 한다.
