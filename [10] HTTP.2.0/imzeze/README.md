# HTTP/2.0

## HTTP/2.0의 등장배경

한 커넥션에서 하나의 요청을 보내고 그에 대한 하나의 응답만 받는 HTTP의 메시지 교환 방식은 단순함 장점이지만, 응답을 받아야만 그 다음 요청을 보낼 수 있기 때문에 심각한 회전 지연을 피할 수 없다.  
2009년, 구글은 웹을 더 빠르게 하겠다는 목표 아래 SPDY 프로토콜을 내놓았다. SPDY는 헤더를 압축하여 대역폭을 절약했고, 하나의 TCP 커넥션에 여러 요청을 동시에 보내 회전 지연을 줄이는 것이 가능했으며, 클라이언트가 요청을 보내지 않아도 서버가 능동적으로 리소스를 푸시하는 기능도 갖추고 있다.  
그 후, HTTP 작업 그룹은 SPDY를 기반으로 HTTP/2.0 프로토 콜 초안을 만들기 시작했다.

<br />

## 개요

- HTTP/2.0은 TCP 커넥션 위에서 동작한다.
- TCP 커넥션을 초기화하는 것은 클라이언트다.
- HTTP/2.0 요청과 응답은 프레임에 담긴다.
- HTTP 헤더는 압축되어 담긴다.
- 프레임은 스트림을 통해 보내진다.
- 한 개의 스트림이 한 쌍의 요청과 응답을 처리한다.
- 하나의 커넥션 위에 여러 개의 스트림이 동시에 만들어질 수 있다. 따라서 여러 개의 요청과 응답을 동시에 처리하는 것 역시 가능하다.
- 서버는 능동적으로 클라이언트에게 리소스를 보낼 수 있다.
- 요청과 응답 메시지의 문법이 HTTP/1.1과는 약간 다를 뿐 그 의미는 같게 설계되었다.

## HTTP/1.1 과의 차이점

### 프레임

프레임은 크게 헤더와 페이로드로 나뉘어진다.  
헤더에는 `페이로드의 길이`, `프레임의 종류`, `식별자` 등이 포함되어 있으며, 페이로드의 형식이나 내용은 프레임의 종류에 따라 다르다.

### 스트림과 멀티플렉싱

- 커넥션 관리
  한 쌍의 HTTP 요청과 응답은 하나의 스트림을 통해 이루어지고, 새로운 요청을 보내기 위해 새로운 스트림을 만들며 응답을 보낸 후에 스트림이 닫힌다.  
  HTTP/1.1에서는 여러 요청을 보내기 위해 TCP 커넥션을 새로 맺는 방법을 이용했으나 이 역시도 지연을 해결할 수 있는 완벽한 해결법이 되지 못한다.  
  HTTP/2.0에서는 스트림을 통해 한 커넥션에서 여러 요청을 동시에 보낼 수 있게 되었다.

- 우선순위 부여  
  웹브라우저는 보다 중요한 리소스를 요청하는 스트림에 우선순위를 부여할 수 있다.

- 스트림 생성 방식  
  서버와 클라이언트는 스트림을 상대방과 협상 없이 일방적으로 만들 수 있기 때문에 연결 지연을 피할 수 있다.

- 스트림 식별자  
  한 커넥션에서 스트림은 고유한 식별자를 가져야한다. 만약 식별자가 고갈된다면 새로운 커넥션을 맺어 해결할 수 있다.

### 헤더 압축

HTTP/1.1에서는 헤더를 압축없이 전송하기 때문에 헤더의 크기가 회전 지연과 대역폭 양쪽 모두에 실질적인 영향을 끼치게 되었다.  
이를 개선하기 위해 HTTP/2.0에서는 HTTP 메시지의 헤더를 압축하여 전송한다. 헤더를 받은 수신 측은 반드시 압축 해제를 수행해야 한다.

### 서버 푸시

HTTP/2.0은 하나의 요청에 대해 여러 응답을 보낼 수 있다. 이 기능은 서버가 클라이언트에서 어떤 리소스를 요구할 것인지 미리 알 수 있는 상황에서 유용하다.  
리소스를 푸시하려는 서버는 아래 단계를 거친다.

1. 클라이언트에게 자원을 푸시할 것임을 알리기 위해 PUSH_PROMISE 프레임을 보낸다.
2. 클라이언트는 RST_STREAM 프레임을 보내어 푸시를 거절할 수 있다. 이 경우 스트림이 즉각 닫힌다.

서버 푸시를 사용할 때 주의 사항은 아래와 같다.

- 서버 푸시를 사용하기로 했더라도, 중간의 프락시가 서버로부터 받은 추가 리소스를 클라이언트에게 전달하지 않을 수 있으며, 반대로 아무런 추가 리소스를 서버로부터 받지 않았음에도 클라이 언트에게 추가 리소스를 전달할 수도 있다.
- 서버는 오직 안전하고, 캐시 가능하고, 본문을 포함하지 않은 요청에 대해서만 푸시를 할수있다.
- PUSH_PROMISE 프레임은 원 요청을 위해 만들어진 스트림을 통해 보내진다.
- 클라이언트는 반드시 서버가 푸시한 리소스를 동일 출처 정책(Same-origin policy) 검사를 해야한다.
- 서버 푸시를 끄고 싶다면 SETTINGS_ENABLE_PUSH을 0으로 설정 하면 된다.

<br />

## 알려진 보안 이슈

### 중개자 캡슐화 공격

HTTP/2.0 메시지를 중간의 프락시가 HTTP/1.1 메시지로 변환할 때 메시지의 의미가 변질될 가능성이 있다.  
HTTP/2.0은 헤더 필드의 이름과 값을 바이너리로 인코딩한다. 때문에 헤더에 어떤 문자열도 허용될 수 있고, HTTP/1.1로 변환되면서 변질될 수 있다.

### 긴 커넥션 유지로 인한 개인정보 누출 우려
